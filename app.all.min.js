function blockFactory(a){var b=a.x,c=a.y,d=[];switch(a.type){case 1:d.push(new Brick({color:a.color,x:b,y:c})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide}));break;case 2:a.angle==0||a.angle==180?(d.push(new Brick({color:a.color,x:b,y:c})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide*2})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide*3}))):(d.push(new Brick({color:a.color,x:b-BrickSide,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide*2,y:c+BrickSide})));break;case 3:a.angle==0&&(d.push(new Brick({color:a.color,x:b,y:c})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide*2})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c}))),a.angle==180&&(d.push(new Brick({color:a.color,x:b,y:c})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide*2})),d.push(new Brick({color:a.color,x:b-BrickSide,y:c+BrickSide*2}))),a.angle==90&&(d.push(new Brick({color:a.color,x:b-BrickSide,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide*2}))),a.angle==270&&(d.push(new Brick({color:a.color,x:b-BrickSide,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b-BrickSide,y:c})));break;case 4:a.angle==0&&(d.push(new Brick({color:a.color,x:b,y:c})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide*2})),d.push(new Brick({color:a.color,x:b-BrickSide,y:c}))),a.angle==90&&(d.push(new Brick({color:a.color,x:b-BrickSide,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c}))),a.angle==180&&(d.push(new Brick({color:a.color,x:b,y:c})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide*2})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide*2}))),a.angle==270&&(d.push(new Brick({color:a.color,x:b-BrickSide,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b-BrickSide,y:c+BrickSide*2})));break;case 5:if(a.angle==0||a.angle==180)d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c})),d.push(new Brick({color:a.color,x:b+BrickSide*2,y:c}));if(a.angle==270||a.angle==90)d.push(new Brick({color:a.color,x:b,y:c-BrickSide})),d.push(new Brick({color:a.color,x:b,y:c})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide}));break;case 6:if(a.angle==0||a.angle==180)d.push(new Brick({color:a.color,x:b,y:c})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide*2,y:c+BrickSide}));if(a.angle==270||a.angle==90)d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b,y:c})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c-BrickSide}));break;case 7:a.angle==270&&(d.push(new Brick({color:a.color,x:b,y:c})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c})),d.push(new Brick({color:a.color,x:b+BrickSide*2,y:c})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide}))),a.angle==180&&(d.push(new Brick({color:a.color,x:b,y:c-BrickSide})),d.push(new Brick({color:a.color,x:b,y:c})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c})),d.push(new Brick({color:a.color,x:b,y:c+BrickSide}))),a.angle==90&&(d.push(new Brick({color:a.color,x:b,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide*2,y:c+BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c}))),a.angle==0&&(d.push(new Brick({color:a.color,x:b+BrickSide,y:c-BrickSide})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c})),d.push(new Brick({color:a.color,x:b,y:c})),d.push(new Brick({color:a.color,x:b+BrickSide,y:c+BrickSide})));break;default:}return d}var Block=function(){this.color=randomColor(),this.y=-80,this.x=width/2,this.angle=90*random(0,3),this.type=random(1,7),this.bricks=[],this.bricks=blockFactory(this),this.remove=function(){$.each(this.bricks,function(a,b){b.remove()})},this.draw=function(a){if(!gameLoop)return!0;this.angle+=a.angle||0,this.angle>=360&&(this.angle=0),this.x+=a.x||0,this.y+=a.y||0,this.remove(),this.bricks=blockFactory(this);if(this.hitsWall()){var b=this.getBBox();return this.undo(a),b.maxY+BrickSide/2<=height}return bricks&&this.intersects(bricks)?(this.undo(a),!1):!0},this.undo=function(a){this.angle+=a.angle*-1||0,this.angle==-90&&(this.angle=270),this.x+=a.x*-1||0,this.y+=a.y*-1||0,this.remove(),this.bricks=blockFactory(this)},this.intersects=function(a){var b=!1,c=this;return a instanceof Array?$.each(a,function(a,d){c.intersectEachBrick(d)&&(b=!0)}):this.intersectEachBrick(a)&&(b=!0),b},this.intersectEachBrick=function(a){var b=!1;return $.each(this.bricks,function(c,d){Raphael.isBBoxIntersect(a.getBBox(),d.getBBox())&&(b=!0)}),b},this.hitsWall=function(){var a=this.getBBox();return a.minX<-1||a.maxX>width||a.maxY>height},this.getBBox=function(){var a=this.x,b=this.y,c=this.x,d=this.y;return $.each(this.bricks,function(e,f){var g=f.attr("x"),h=f.attr("y");g<a&&(a=g),g>c&&(c=g),h<b&&(b=h),h>d&&(d=h)}),{minX:a,minY:b,maxX:c,maxY:d}}},Brick=function(a){return this.y=a.y,this.x=a.x,this.ele=paper.rect(this.x+1,this.y+1,BrickSide-2,BrickSide-2,2,2),this.ele.attr({fill:a.color}),this.ele},EVENTS={},KEYS={W:87,A:65,S:83,D:68,LEFT:37,UP:38,RIGHT:39,DOWN:40,P:80,SPACE:32},free=!0;$(window).bind("keydown",function(a){if(!free)return!0;free=!1;switch(a.which){case KEYS.W:case KEYS.UP:EVENTS.ROTATE=!0;break;case KEYS.A:case KEYS.LEFT:EVENTS.LEFT=!0;break;case KEYS.S:case KEYS.DOWN:EVENTS.DOWN=!0;break;case KEYS.D:case KEYS.RIGHT:EVENTS.RIGHT=!0;break;case KEYS.P:case KEYS.SPACE:gameLoop?(clearInterval(gameLoop),gameLoop=null,$("#game").css({opacity:.5}),$("#over").html("take a break"),$("#over").css({zIndex:2e3,display:"block"})):(gameLoop=setInterval(loop,speed),$("#game").css({opacity:1}),$("#over").css({zIndex:1,display:"none"}));break;default:}handle()}),$("#content").hammer({prevent_default:!0,drag_vertical:!1,swipe_time:800,swipe_min_distance:10}).bind("tap swipe",function(a){if(!free)return!0;free=!1,a.type=="swipe"&&(EVENTS.LEFT=a.direction=="left",EVENTS.RIGHT=a.direction=="right",EVENTS.DOWN=a.direction=="down"),a.type=="tap"&&(EVENTS.ROTATE=!0),handle()});var handle=function(){EVENTS.ROTATE&&(move.angle+=90),EVENTS.LEFT&&(move.x-=BrickSide),EVENTS.DOWN&&(move.y+=BrickSide),EVENTS.RIGHT&&(move.x+=BrickSide),currentBlock&&currentBlock.draw(move),move={x:0,y:0,angle:0},EVENTS={},free=!0},randomColor=function(){return"#"+function a(b){return(b+=[0,1,2,3,4,5,6,7,8,9,"a","b","c","d","e","f"][Math.floor(Math.random()*16)])&&b.length==6?b:a(b)}("")},random=function(a,b){return Math.floor(Math.random()*b+a)},width=$("#game").width(),height=$("#game").height(),paper=Raphael(document.getElementById("game"),width,height),widthNext=$("#nextBlock").width(),heightNext=$("#nextBlock").height(),paperNextBlock=Raphael(document.getElementById("nextBlock"),widthNext,heightNext),BrickSide=20,speed=700,currentBlock=null,nextBlock=null,nextSet=paperNextBlock.set(),move={},bricks=[],score=0;$("#score").html(score);var lastUpdate=0,walls={};walls.left=paper.rect(-BrickSide,0,BrickSide,height,1,1),walls.right=paper.rect(width+BrickSide,0,BrickSide,height,1,1),walls.bottom=paper.rect(0,height,width,BrickSide,1,1),walls.left.attr({opacity:0}),walls.right.attr({opacity:0}),walls.bottom.attr({opacity:0});var loop=function(){var a=Date.now(),b=a-lastUpdate;b>=3e4&&(lastUpdate=a,speed-=50,clearInterval(gameLoop),gameLoop=setInterval(loop,speed));if(!currentBlock){nextBlock||(nextBlock=new Block),currentBlock=nextBlock,paperNextBlock.clear(),nextSet&&nextSet.animate({transform:"t50,150"},100,"elastic"),nextSet=paperNextBlock.set(),nextBlock=new Block,$.each(nextBlock.bricks,function(a,b){var c=b.attr("y"),d=b.attr("x"),e=b.attr("fill"),f=paperNextBlock.rect(nextBlock.x-d+1,nextBlock.y-c+1,BrickSide-2,BrickSide-2,2,2);f.attr({fill:e}),nextSet.push(f)});var c=nextSet.getBBox();paperNextBlock.add(nextSet),nextSet.animate({transform:"...T"+(c.x*-1+(50-c.width/2))+","+(c.y*-1+(50-c.height/2))},100,"elastic")}move={x:0,y:0,angle:0},move.y+=BrickSide,currentBlock.draw(move)||(currentBlock.getBBox().minY<0&&(clearInterval(gameLoop),$("#game").css({opacity:.5}),$("#over").html("game over"),$("#over").css({zIndex:2e3,display:"block"})),bricks=$.merge(bricks,currentBlock.bricks),currentBlock=null);var d=0,e={},f=[],g=[];$.each(bricks,function(a,b){var c=b.attr("x"),h=b.attr("y");e[h]||(e[h]=[]),e[h].push(b),e[h].length==10&&(d++,f=$.merge(f,e[h]),g.push(h),delete e[h])});if(d>0){switch(d){case 1:score+=10;break;case 2:score+=25;break;case 3:score+=40;break;case 4:score+=60;break;default:}$("#score").html(score),clearInterval(gameLoop);var h=paper.set();$.each(f,function(a,b){h.push(b)}),h.animate({opacity:0,transform:"s0r360"},1e3,"bounce",function(){h.remove(),bricks=[],$.each(e,function(a,b){$.merge(bricks,b)}),g.sort(function(a,b){return a-b});var a=[],b=[];$.each(g,function(c,d){a=[],$.each(bricks,function(c,e){var f=e.attr("y"),g=e.attr("x"),h=e.attr("fill");f<d?(b.push(e),a.push(new Brick({x:g-1,y:f-1+BrickSide,color:h}))):a.push(e)}),delete bricks,bricks=$.merge([],a),delete a}),$.each(b,function(a,b){b.remove()}),gameLoop=setInterval(loop,speed)})}},gameLoop=setInterval(loop,speed);