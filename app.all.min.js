(function(){
function blockFactory(a,b){var c=a.x,d=a.y,e=[];switch(a.type){case 1:e.push(new Brick({color:a.color,x:c,y:d},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide},b));break;case 2:a.angle==0||a.angle==180?(e.push(new Brick({color:a.color,x:c,y:d},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide*2},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide*3},b))):(e.push(new Brick({color:a.color,x:c-BrickSide,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide*2,y:d+BrickSide},b)));break;case 3:a.angle==0&&(e.push(new Brick({color:a.color,x:c,y:d},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide*2},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d},b))),a.angle==180&&(e.push(new Brick({color:a.color,x:c,y:d},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide*2},b)),e.push(new Brick({color:a.color,x:c-BrickSide,y:d+BrickSide*2},b))),a.angle==90&&(e.push(new Brick({color:a.color,x:c-BrickSide,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide*2},b))),a.angle==270&&(e.push(new Brick({color:a.color,x:c-BrickSide,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c-BrickSide,y:d},b)));break;case 4:a.angle==0&&(e.push(new Brick({color:a.color,x:c,y:d},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide*2},b)),e.push(new Brick({color:a.color,x:c-BrickSide,y:d},b))),a.angle==90&&(e.push(new Brick({color:a.color,x:c-BrickSide,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d},b))),a.angle==180&&(e.push(new Brick({color:a.color,x:c,y:d},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide*2},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide*2},b))),a.angle==270&&(e.push(new Brick({color:a.color,x:c-BrickSide,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c-BrickSide,y:d+BrickSide*2},b)));break;case 5:if(a.angle==0||a.angle==180)e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d},b)),e.push(new Brick({color:a.color,x:c+BrickSide*2,y:d},b));if(a.angle==270||a.angle==90)e.push(new Brick({color:a.color,x:c,y:d-BrickSide},b)),e.push(new Brick({color:a.color,x:c,y:d},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide},b));break;case 6:if(a.angle==0||a.angle==180)e.push(new Brick({color:a.color,x:c,y:d},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide*2,y:d+BrickSide},b));if(a.angle==270||a.angle==90)e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c,y:d},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d-BrickSide},b));break;case 7:a.angle==270&&(e.push(new Brick({color:a.color,x:c,y:d},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d},b)),e.push(new Brick({color:a.color,x:c+BrickSide*2,y:d},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide},b))),a.angle==180&&(e.push(new Brick({color:a.color,x:c,y:d-BrickSide},b)),e.push(new Brick({color:a.color,x:c,y:d},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d},b)),e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b))),a.angle==90&&(e.push(new Brick({color:a.color,x:c,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide*2,y:d+BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d},b))),a.angle==0&&(e.push(new Brick({color:a.color,x:c+BrickSide,y:d-BrickSide},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d},b)),e.push(new Brick({color:a.color,x:c,y:d},b)),e.push(new Brick({color:a.color,x:c+BrickSide,y:d+BrickSide},b)));break;default:}return e}function checkFullines(){var a=0,b={},c=[],d=[];$.each(bricks,function(e,f){var g=f.attr("x"),h=f.attr("y");b[h]||(b[h]=[]),b[h].push(f),b[h].length==10&&(a++,c=$.merge(c,b[h]),d.push(h),delete b[h])});if(a>0){switch(a){case 1:score+=10;break;case 2:score+=25;break;case 3:score+=40;break;case 4:score+=60;break;default:}$("#score").html(score),score-lastUpdateScore>=20&&(lastUpdateScore=score,speed-=30,clearInterval(gameLoop),gameLoop=setInterval(loop,speed)),clearInterval(gameLoop);var e=paper.set();$.each(c,function(a,b){e.push(b)}),e.animate({opacity:0,transform:"s0r360"},1e3,"bounce",function(){e.remove(),bricks=[],$.each(b,function(a,b){$.merge(bricks,b)}),d.sort(function(a,b){return a-b});var a=[],c=[];$.each(d,function(b,d){a=[],$.each(bricks,function(b,e){var f=e.attr("y"),g=e.attr("x"),h=e.attr("fill");f<d?(c.push(e),a.push(new Brick({x:g-1,y:f-1+BrickSide,color:h}))):a.push(e)}),delete bricks,bricks=$.merge([],a),delete a}),$.each(c,function(a,b){b.remove()}),gameLoop=setInterval(loop,speed)})}}function loadSound(a,b,c){var d=new XMLHttpRequest;d.open("GET",a,!0),d.responseType="arraybuffer",d.onload=function(){context.decodeAudioData(d.response,function(a){sounds[b]=a,c&&c()},function(){})},d.send()}function playSound(a,b){var c=context.createBufferSource();c.buffer=a,c.loop=b,c.connect(context.destination),c.noteOn(0)}var Block=function(a,b){b=b||{},this.color=b.color||randomColor(),this.y=b.y||-80,this.x=b.x||width/2,this.angle=b.angle||90*random(0,3),this.type=b.type||random(1,7),this.bricks=[],this.bricks=blockFactory(this,a),this.remove=function(){$.each(this.bricks,function(a,b){b.remove()})},this.draw=function(a){if(!gameLoop)return!0;this.angle+=a.angle||0,this.angle>=360&&(this.angle=0),this.x+=a.x||0,this.y+=a.y||0,this.remove(),this.bricks=blockFactory(this);if(this.hitsWall()){var b=this.getBBox();return this.undo(a),b.maxY+BrickSide/2<=height}return bricks&&this.intersects(bricks)?(this.undo(a),!1):!0},this.undo=function(a){this.angle+=a.angle*-1||0,this.angle==-90&&(this.angle=270),this.x+=a.x*-1||0,this.y+=a.y*-1||0,this.remove(),this.bricks=blockFactory(this)},this.intersects=function(a){var b=!1,c=this;return a instanceof Array?$.each(a,function(a,d){c.intersectEachBrick(d)&&(b=!0)}):this.intersectEachBrick(a)&&(b=!0),b},this.intersectEachBrick=function(a){var b=!1;return $.each(this.bricks,function(c,d){Raphael.isBBoxIntersect(a.getBBox(),d.getBBox())&&(b=!0)}),b},this.hitsWall=function(){var a=this.getBBox();return a.minX<-1||a.maxX>width||a.maxY>height},this.getBBox=function(){var a=this.x,b=this.y,c=this.x,d=this.y;return $.each(this.bricks,function(e,f){var g=f.attr("x"),h=f.attr("y");g<a&&(a=g),g>c&&(c=g),h<b&&(b=h),h>d&&(d=h)}),{minX:a,minY:b,maxX:c,maxY:d}}},Brick=function(a,b){return b=b||paper,this.y=a.y,this.x=a.x,this.ele=b.rect(this.x+1,this.y+1,BrickSide-2,BrickSide-2,2,2),this.ele.attr({fill:a.color}),this.ele},EVENTS={},KEYS={W:87,A:65,S:83,D:68,LEFT:37,UP:38,RIGHT:39,DOWN:40,P:80,SPACE:32},free=!0;$(window).bind("keydown",function(a){if(!free)return!0;free=!1;switch(a.which){case KEYS.W:case KEYS.UP:EVENTS.ROTATE=!0;break;case KEYS.A:case KEYS.LEFT:EVENTS.LEFT=!0;break;case KEYS.S:case KEYS.DOWN:EVENTS.DOWN=!0;break;case KEYS.D:case KEYS.RIGHT:EVENTS.RIGHT=!0;break;case KEYS.P:case KEYS.SPACE:gameLoop?(clearInterval(gameLoop),gameLoop=null,$("#game").css({opacity:.5}),$("#over").html("take a break"),$("#over").css({zIndex:2e3,display:"block"})):(gameLoop=setInterval(loop,speed),$("#game").css({opacity:1}),$("#over").css({zIndex:1,display:"none"}));break;default:}handle()}),$("#content").hammer({prevent_default:!0,drag_vertical:!1,swipe_time:800,swipe_min_distance:10}).bind("tap swipe",function(a){if(!free)return!0;free=!1,a.type=="swipe"&&(EVENTS.LEFT=a.direction=="left",EVENTS.RIGHT=a.direction=="right",EVENTS.DOWN=a.direction=="down"),a.type=="tap"&&(EVENTS.ROTATE=!0),handle()});var handle=function(){EVENTS.ROTATE&&(move.angle+=90),EVENTS.LEFT&&(move.x-=BrickSide),EVENTS.DOWN&&(move.y+=BrickSide),EVENTS.RIGHT&&(move.x+=BrickSide),currentBlock&&currentBlock.draw(move),move={x:0,y:0,angle:0},EVENTS={},free=!0},sounds={},context;window.addEventListener("load",function(){try{context=new webkitAudioContext,loadSound("resources/sounds/Tetris-Theme-Original.mp3","track",function(){playSound(sounds.track,!0)})}catch(a){alert("Web Audio API is not supported in this browser")}},!1);var colors=["0,204,0","217,0,126","255,204,0"],randomColor=function(){return"rgb("+colors[random(0,2)]+")"},random=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},width=$("#game").width(),height=$("#game").height(),paper=Raphael(document.getElementById("game"),width,height),widthNext=$("#nextBlock").width(),heightNext=$("#nextBlock").height(),paperNextBlock=Raphael(document.getElementById("nextBlock"),widthNext,heightNext),BrickSide=20,speed=500,currentBlock=null,nextBlock=null,nextSet=paperNextBlock.set(),move={},bricks=[],score=0;$("#score").html(score);var lastUpdateScore=0,walls={};walls.left=paper.rect(-BrickSide,0,BrickSide,height,1,1),walls.right=paper.rect(width+BrickSide,0,BrickSide,height,1,1),walls.bottom=paper.rect(0,height,width,BrickSide,1,1),walls.left.attr({opacity:0}),walls.right.attr({opacity:0}),walls.bottom.attr({opacity:0});var loop=function(){currentBlock||(nextBlock||(nextBlock=new Block),currentBlock=nextBlock,paperNextBlock.clear(),nextBlock=new Block,nextSet=new Block(paperNextBlock,{color:nextBlock.color,x:BrickSide,y:BrickSide,angle:nextBlock.angle,type:nextBlock.type})),move={x:0,y:0,angle:0},move.y+=BrickSide,currentBlock.draw(move)||(currentBlock.getBBox().minY<0&&(clearInterval(gameLoop),$("#game").css({opacity:.5}),$("#over").html("game over"),$("#over").css({zIndex:2e3,display:"block"})),bricks=$.merge(bricks,currentBlock.bricks),currentBlock=null,checkFullines())},gameLoop=setInterval(loop,speed);
})();